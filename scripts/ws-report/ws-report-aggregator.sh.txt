#!/bin/sh
# Aravind Datta, 5/1/2017
# This script aggregates previously generated reports into one email for convenience
# it works when used with ws-summ-perf-report.sh. it has no meaning by itself and
# can be merged into ws-summ-perf-report.sh at a later point


# define usage
if [[ -z $1 ]]; then
   echo "Usage: This script is meant to be invoked from ws-summ-perf-report.sh."
   echo "       If invoked separately, it takes 4 parameters:"
   echo "       [ws monthly report name] [3 char month] [email from] [email to]"
   exit 1;
fi


# define variables
CLIENT=VGI
GNU_DATE=`which date`
TODAY=`$GNU_DATE +%y%m%d`
HOSTNAME=`uname -n | cut -d'.' -f1`
REPORT_HOME=~/scripts

# report name and month are passed from report script: ws-summ-perf-report.sh
REPORT_TXT=$1
LM_STR=$2
EMAIL_FROM=$3
EMAIL_TO=$4

BIZ=`echo $REPORT_TXT | awk -F'-' '{print $3}'`
RMONTH=`echo $REPORT_TXT | awk -F'-' '{print $4}'`
RYEAR=`echo $REPORT_TXT | awk -F'-' '{print $5}'`
REPORT_DETAILS=report-details_$BIZ-$RMONTH-$RYEAR
REPORT_AGGR=report-aggr_$BIZ-$RMONTH-$RYEAR


# get report from ws4 first 'cus u know that's done
echo "$CLIENT $BIZ Webservice combined performance statistics report from all servers:" > $REPORT_AGGR
echo " " >> $REPORT_AGGR
echo "From $HOSTNAME: " >> $REPORT_AGGR
tail -4 $REPORT_TXT >> $REPORT_AGGR
echo " " >> $REPORT_AGGR


# now get report content from ws5/ws6
for i in vgprod1-ws5 vgprod1-ws6; do
   echo $i;
   numOfFiles=`ssh $i "cd $REPORT_HOME; ls report_$i-$BIZ-$RMONTH-$RYEAR" | wc -l`
   echo "num of files: "$numOfFiles
   numOfFilesRequired=1

   CUT_OFF_TIME=`echo $TODAY"0130"`

   while [ "$numOfFiles" -lt "$numOfFilesRequired" ];
   do
      CURRENT_TIME=`date +%y%m%d%H%M`
      if [ "$CURRENT_TIME" -gt "$CUT_OFF_TIME" ]; then
         echo "WS summary report might not have been generated by cutoff time of 12:30am; aborting..." > noreport.log
         mailx -s "FAILED: MONTHLY $CLIENT Webservice Performance Statistics Report" $EMAIL_TO < noreport.log
         exit -1;
      else
         numOfFiles=`ssh $i "cd $REPORT_HOME; ls report_$i-$BIZ-$RMONTH-$RYEAR" | wc -l`
         [ "$numOfFiles" -lt "$numOfFilesRequired" ] && sleep 300s
      fi
   done

   # if files ready, then, append report file to agg file and copy details file
   echo "From $i: " >> $REPORT_AGGR
   ssh $i "cd $REPORT_HOME; tail -n4 report_$i-$BIZ-$RMONTH-$RYEAR" >> $REPORT_AGGR
   echo " " >> $REPORT_AGGR

   # get the detail file
   scp $i:$REPORT_HOME/report-details_$i-$BIZ-$RMONTH-$RYEAR ./
done

# finalize attachments
A1=`ls report-details_*$BIZ-$RMONTH-$RYEAR | awk '{print $0}' | grep vgprod1-ws4`
A2=`ls report-details_*$BIZ-$RMONTH-$RYEAR | awk '{print $0}' | grep vgprod1-ws5`
A3=`ls report-details_*$BIZ-$RMONTH-$RYEAR | awk '{print $0}' | grep vgprod1-ws6`


# email aggregate report
cat $REPORT_AGGR | nail -r $EMAIL_FROM -a $A1 -a $A2 -a $A3 -s "MONTHLY $CLIENT "$BIZ" Webservice Performance Statistics Report for $LM_STR $RYEAR" $EMAIL_TO


# end of report
